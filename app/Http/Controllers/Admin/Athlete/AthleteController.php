<?php

namespace App\Http\Controllers\Admin\Athlete;

use App\Http\Controllers\Controller;
use App\Http\Requests\Admin\UpdateActivityRequest;
use App\Http\Requests\Admin\UpdateSortEntityRequest;
use App\Models\Admin\Athlete\Athlete;
use App\Models\Admin\Athlete\AthleteImage;
use App\Http\Requests\Admin\Athlete\AthleteRequest;
use App\Http\Resources\Admin\Athlete\AthleteResource;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;
use Inertia\Inertia;
use Inertia\Response;
use Throwable;

/**
 * –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –°–ø–æ—Ä—Ç—Å–º–µ–Ω–∞–º–∏ –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏.
 *
 * –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏, –∞ —Ç–∞–∫–∂–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
 * - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–æ–¥–∏–Ω–æ—á–Ω–æ–µ –∏ –º–∞—Å—Å–æ–≤–æ–µ)
 *
 * @version 1.1 (–£–ª—É—á—à–µ–Ω —Å RMB, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏, Form Requests)
 * @author –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ö–æ—Å–æ–ª–∞–ø–æ–≤ <kosolapov1976@gmail.com>
 * @see \App\Models\Admin\Athlete\Athlete –ú–æ–¥–µ–ª—å –°–ø–æ—Ä—Ç—Å–º–µ–Ω–∞
 * @see \App\Http\Requests\Admin\Athlete\AthleteRequest –ó–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
 */
class AthleteController extends Controller
{
    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤.
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.
     * –ü–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.
     * –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ.
     *
     * GET /admin/athletes
     * @param Request $request
     * @return Response
     */
    public function index(Request $request): Response
    {
        // TODO: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ $this->authorize('view-athlete', Athlete::class);

        $adminCountAthletes = config('site_settings.AdminCountAthletes', 15);
        $adminSortAthletes = config('site_settings.AdminSortAthletes', 'idDesc');

        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Å—Ç–∞—Ç—å–∏ —Å —Å–µ–∫—Ü–∏—è–º–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏, —Å—á—ë—Ç—á–∏–∫–∏ —Ç–µ–≥–æ–≤, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ª–∞–π–∫–æ–≤
            $athletes = Athlete::withCount(['images'])
                ->with(['images'])
                ->get();

            $athletesCount = $athletes->count(); // –°—á–∏—Ç–∞–µ–º –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏

        } catch (Throwable $e) {
            Log::error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤ –¥–ª—è Index: " . $e->getMessage());
            $athletes = collect(); // –ü—É—Å—Ç–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            $athletesCount = 0;
            session()->flash('error', __('admin/controllers/athletes.index_error'));
        }

        return Inertia::render('Admin/Athletes/Index', [
            'athletes' => AthleteResource::collection($athletes),
            'athletesCount' => $athletesCount,
            'adminCountAthletes' => (int)$adminCountAthletes,
            'adminSortAthletes' => $adminSortAthletes,
        ]);
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞.
     *
     *  GET /admin/athletes/create
     * @return Response
     */
    public function create(): Response
    {
        // TODO: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ $this->authorize('create-athlete', Athlete::class);
        return Inertia::render('Admin/Athletes/Create');
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AthleteRequest –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
     * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
     *
     *  POST /admin/athletes
     * @param AthleteRequest $request
     * @return RedirectResponse –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–µ–π —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
     */
    public function store(AthleteRequest $request): RedirectResponse
    {
        $data = $request->validated();
        // Log::debug('üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞', ['validated' => $data]);

        if ($request->hasFile('avatar')) {
            $path = $request->file('avatar')->store('athlete_avatar', 'public');
            $data['avatar'] = $path;
            // Log::debug('üì¶ –ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω', ['path' => $path]);
        }

        $imagesData = $data['images'] ?? [];
        unset($data['images']);

        DB::beginTransaction();
        try {
            $athlete = Athlete::create($data);

            if (!$athlete || !$athlete->exists) {
                Log::error('‚ùå –°–ø–æ—Ä—Ç—Å–º–µ–Ω –Ω–µ —Å–æ–∑–¥–∞–Ω!', ['data' => $data]);
                throw new \Exception('–ú–æ–¥–µ–ª—å —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞');
            }

            // Log::debug('‚úÖ –°–ø–æ—Ä—Ç—Å–º–µ–Ω —Å–æ–∑–¥–∞–Ω', ['id' => $athlete->id, 'nickname' => $athlete->nickname]);

            $imageSyncData = [];
            $imageIndex = 0;

            foreach ($imagesData as $imageData) {
                $fileKey = "images.{$imageIndex}.file";
                // Log::debug('üñºÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', ['index' => $imageIndex, 'data' => $imageData]);

                if ($request->hasFile($fileKey)) {
                    $image = AthleteImage::create([
                        'order'   => $imageData['order']   ?? 0,
                        'alt'     => $imageData['alt']     ?? '',
                        'caption' => $imageData['caption'] ?? '',
                    ]);

                    try {
                        $file = $request->file($fileKey);

                        if ($file->isValid()) {
                            $image->addMedia($file)->toMediaCollection('images');
                            $imageSyncData[$image->id] = ['order' => $image->order];
                            // Log::debug('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–µ–¥–∏–∞—Ç–µ–∫—É', ['image_id' => $image->id]);
                        } else {
                            Log::warning("‚ö†Ô∏è –§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–≤–∞–ª–∏–¥–µ–Ω", [
                                'index' => $imageIndex,
                                'fileKey' => $fileKey,
                                'error' => $file->getErrorMessage()
                            ]);
                            $image->delete();
                        }
                    } catch (Throwable $e) {
                        Log::error("‚ùó –û—à–∏–±–∫–∞ Spatie –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", [
                            'index' => $imageIndex,
                            'message' => $e->getMessage()
                        ]);
                        $image->delete();
                    }
                }

                $imageIndex++;
            }

            $athlete->images()->sync($imageSyncData);
            DB::commit();

            // Log::info('üèÅ –°–ø–æ—Ä—Ç—Å–º–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', ['id' => $athlete->id]);
            return redirect()->route('admin.athletes.index')->with('success', __('admin/controllers/athletes.created'));

        } catch (Throwable $e) {
            DB::rollBack();
            Log::error("üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞", [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            return back()->withInput()->withErrors(['general' => __('admin/controllers/athletes.create_error')]);
        }
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Route Model Binding –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏.
     *
     *  GET /admin/athletes/{athlete}/edit
     * @param Athlete $athlete –ú–æ–¥–µ–ª—å —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞, –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ ID –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞.
     * @return Response
     */
    public function edit(Athlete $athlete): Response
    {
        // TODO: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ $this->authorize('update-athlete', $athlete);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–≤—è–∑–∏
        $athlete->load(['images' => fn($q) => $q->orderBy('order', 'asc')]);

        return Inertia::render('Admin/Athletes/Edit', [
            'athlete' => new AthleteResource($athlete),
        ]);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AthleteRequest –∏ Route Model Binding.
     * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã.
     *
     *  PUT /admin/athletes/{athlete}
     *  PATCH /admin/athletes/{athlete}
     * @param AthleteRequest $request –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å.
     * @param Athlete $athlete –ú–æ–¥–µ–ª—å —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
     * @return RedirectResponse –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
     */
    public function update(AthleteRequest $request, Athlete $athlete): RedirectResponse
    {
        $data = $request->validated();

        // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
        $imagesData       = $data['images'] ?? [];
        $deletedImageIds  = $data['deletedImages'] ?? [];

        // –£–±–∏—Ä–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ $data
        unset(
            $data['images'],
            $data['deletedImages'],
            $data['_method']
        );

        try {
            DB::beginTransaction();

            // 1) –£–¥–∞–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if (!empty($deletedImageIds)) {
                // –æ—Ç–≤—è–∑—ã–≤–∞–µ–º –æ—Ç pivot
                $athlete->images()->detach($deletedImageIds);
                // —É–¥–∞–ª—è–µ–º —Å–∞–º–∏ –∑–∞–ø–∏—Å–∏ –∏ —Ñ–∞–π–ª—ã
                $this->deleteImages($deletedImageIds);
            }

            // 2) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –î–û update)
            if ($request->hasFile('avatar')) {
                // —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                if ($athlete->avatar && Storage::disk('public')->exists($athlete->avatar)) {
                    Storage::disk('public')->delete($athlete->avatar);
                }

                // –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π
                $path = $request->file('avatar')->store('athlete_avatar', 'public');
                $data['avatar'] = $path;
            }

            // 3) –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
            $athlete->update($data);

            // 4) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            $syncData = [];
            foreach ($imagesData as $index => $imageData) {
                $fileKey = "images.{$index}.file";

                // a) –°—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if (!empty($imageData['id'])) {
                    $img = AthleteImage::find($imageData['id']);

                    // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è
                    if ($img && !in_array($img->id, $deletedImageIds, true)) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º order, alt, caption
                        $img->update([
                            'order'   => $imageData['order']   ?? $img->order,
                            'alt'     => $imageData['alt']     ?? $img->alt,
                            'caption' => $imageData['caption'] ?? $img->caption,
                        ]);

                        // –ï—Å–ª–∏ –ø—Ä–∏—à—ë–ª –Ω–æ–≤—ã–π —Ñ–∞–π–ª ‚Äî –º–µ–Ω—è–µ–º –º–µ–¥–∏–∞
                        if ($request->hasFile($fileKey)) {
                            $img->clearMediaCollection('images');
                            $img->addMedia($request->file($fileKey))
                                ->toMediaCollection('images');
                        }

                        // –ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è pivot sync
                        $syncData[$img->id] = ['order' => $img->order];
                    }

                    // b) –ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ—Ç ID, –Ω–æ –µ—Å—Ç—å —Ñ–∞–π–ª)
                } elseif ($request->hasFile($fileKey)) {
                    $new = AthleteImage::create([
                        'order'   => $imageData['order']   ?? 0,
                        'alt'     => $imageData['alt']     ?? '',
                        'caption' => $imageData['caption'] ?? '',
                    ]);

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
                    $new->addMedia($request->file($fileKey))
                        ->toMediaCollection('images');

                    $syncData[$new->id] = ['order' => $new->order];
                }
            }

            // 5) –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∏ –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ pivot
            $athlete->images()->sync($syncData);

            DB::commit();

            Log::info('–°–ø–æ—Ä—Ç—Å–º–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω: ', ['id' => $athlete->id, 'title' => $athlete->nickname]);
            return redirect()->route('admin.athletes.index')->with('success', __('admin/controllers/athletes.updated'));

        } catch (Throwable $e) {
            DB::rollBack();
            Log::error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ ID {$athlete->id}: {$e->getMessage()}", [
                'trace' => $e->getTraceAsString(),
            ]);
            return back()->withInput()->withErrors(['general' => __('admin/controllers/athletes.update_error')]);
        }
    }

    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –≤–º–µ—Å—Ç–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Route Model Binding. –°–≤—è–∑–∏ —É–¥–∞–ª—è—é—Ç—Å—è –∫–∞—Å–∫–∞–¥–Ω–æ.
     *
     *  DELETE /admin/athletes/{athlete}
     * @param Athlete $athlete –ú–æ–¥–µ–ª—å —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.
     * @return RedirectResponse –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
     */
    public function destroy(Athlete $athlete): RedirectResponse
    {
        // TODO: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ $this->authorize('delete-athlete', $athlete);

        try {
            DB::beginTransaction();
            // –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ AthleteImage –∏ –∏—Ö –º–µ–¥–∏–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ deleteImages
            $this->deleteImages($athlete->images()->pluck('id')->toArray());
            $athlete->delete(); // –°–≤—è–∑–∏ —Å —Å–µ–∫—Ü–∏—è–º–∏ —É–¥–∞–ª—è—Ç—Å—è –∫–∞—Å–∫–∞–¥–Ω–æ
            DB::commit();

            Log::info('–°–ø–æ—Ä—Ç—Å–º–µ–Ω —É–¥–∞–ª–µ–Ω: ID ' . $athlete->id);
            return redirect()->route('admin.athletes.index')->with('success', __('admin/controllers/athletes.deleted'));

        } catch (Throwable $e) {
            DB::rollBack();
            Log::error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ ID {$athlete->id}: " . $e->getMessage());
            return back()->withErrors(['general' => __('admin/controllers/athletes.delete_error')]);
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–∞–Ω–Ω–µ—Ä–∞.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Route Model Binding –∏ UpdateActivityRequest.
     *
     * @param UpdateActivityRequest $request –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –ø–æ–ª–µ–º 'activity'.
     * @param Athlete $athlete –ú–æ–¥–µ–ª—å –±–∞–Ω–Ω–µ—Ä–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
     * @return RedirectResponse –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞–∑–∞–¥ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
     */
    public function updateActivity(UpdateActivityRequest $request, Athlete $athlete): RedirectResponse
    {
        // authorize() –≤ UpdateActivityRequest
        $validated = $request->validated();

        try {

            DB::beginTransaction();
            $athlete->activity = $validated['activity'];
            $athlete->save();
            DB::commit();

            Log::info("–û–±–Ω–æ–≤–ª–µ–Ω–æ activity —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ ID {$athlete->id} –Ω–∞ {$athlete->activity}");
            $actionText = $athlete->activity ? __('admin/controllers/common.activated')
                : __('admin/controllers/common.deactivated');
            return back()
                ->with('success', __('admin/controllers/athletes.activity', ['title' => $athlete->title, 'action' => $actionText]));

        } catch (Throwable $e) {
            DB::rollBack();
            Log::error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ ID {$athlete->id}: " . $e->getMessage());
            return back()->withErrors(['general' => __('admin/controllers/athletes.update_activity_error')]);
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∞—Å—Å–æ–≤–æ
     *
     * @param Request $request
     * @return JsonResponse Json –æ—Ç–≤–µ—Ç
     */
    public function bulkUpdateActivity(Request $request): JsonResponse
    {
        $data = $request->validate([
            'ids'      => 'required|array',
            'ids.*'    => 'required|integer|exists:athletes,id',
            'activity' => 'required|boolean',
        ]);

        Athlete::whereIn('id', $data['ids'])->update(['activity' => $data['activity']]);

        return response()->json(['success' => true]);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Route Model Binding –∏ UpdateSortEntityRequest.
     *
     * @param UpdateSortEntityRequest $request –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –ø–æ–ª–µ–º 'sort'.
     * @param Athlete $athlete –ú–æ–¥–µ–ª—å —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
     * @return RedirectResponse –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞–∑–∞–¥ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º..
     */
    public function updateSort(UpdateSortEntityRequest $request, Athlete $athlete): RedirectResponse
    {
        // authorize() –≤ UpdateSortEntityRequest
        $validated = $request->validated();

        try {
            DB::beginTransaction();
            $athlete->sort = $validated['sort'];
            $athlete->save();
            DB::commit();

            Log::info("–û–±–Ω–æ–≤–ª–µ–Ω–æ sort —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ ID {$athlete->id} –Ω–∞ {$athlete->sort}");
            return back();

        } catch (Throwable $e) {
            DB::rollBack();
            Log::error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ ID {$athlete->id}: " . $e->getMessage());
            return back()->withErrors(['sort' => __('admin/controllers/athletes.update_sort_error')]);
        }
    }

    /**
     * –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ ID.
     * –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–∞ `[{id: 1, sort: 10}, {id: 5, sort: 20}]`.
     *
     * @param Request $request –ó–∞–ø—Ä–æ—Å —Å –º–∞—Å—Å–∏–≤–æ–º 'athletes'.
     * @return RedirectResponse –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞–∑–∞–¥ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
     */
    public function updateSortBulk(Request $request): RedirectResponse
    {
        // TODO: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ $this->authorize('update-athletes');

        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–π –º–∞—Å—Å–∏–≤ (–ú–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π FormRequest: UpdateSortBulkRequest)
        $validated = $request->validate([
            'athletes' => 'required|array',
            'athletes.*.id' => ['required', 'integer', 'exists:athletes,id'],
            'athletes.*.sort' => ['required', 'integer', 'min:1'],
        ]);

        try {
            DB::beginTransaction();
            foreach ($validated['athletes'] as $athleteData) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º update –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, –∏–ª–∏ where/update
                Athlete::where('id', $athleteData['id'])->update(['sort' => $athleteData['sort']]);
            }
            DB::commit();

            Log::info('–ú–∞—Å—Å–æ–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤', ['count' => count($validated['athletes'])]);
            return back();

        } catch (Throwable $e) {
            DB::rollBack();
            Log::error("–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤: " . $e->getMessage());
            return back()->withErrors(['general' => __('admin/controllers/athletes.bulk_update_sort_error')]);
        }
    }

    /**
     * –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–¥–ª—è Spatie)
     *
     * @param array $imageIds
     * @return void
     */
    private function deleteImages(array $imageIds): void
    {
        if (empty($imageIds)) return;
        $imagesToDelete = AthleteImage::whereIn('id', $imageIds)->get();
        foreach ($imagesToDelete as $image) {
            $image->clearMediaCollection('images');
            $image->delete();
        }
        Log::info('–£–¥–∞–ª–µ–Ω—ã –∑–∞–ø–∏—Å–∏ AthleteImage –∏ –∏—Ö –º–µ–¥–∏–∞: ', ['image_ids' => $imageIds]);
    }

}
